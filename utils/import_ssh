#!/bin/bash
# env:
## IP_ADDRESS,PORT,USERNAME,PRIVATE_KEY


SYNCPASS_VERSION_PATH="~/.syncpass_version"
PASSWORD_STORE_ZIP_FILENAME_LOCAL=".syncpass_passwordstore_compressed_local.tar.gz"
PASSWORD_STORE_ZIP_FILENAME_SERVER=".syncpass_passwordstore_compressed_server.tar.gz"

private_func_get_ssh_command() {
    if [[ -z $PORT ]]; then
        PORT=22
    fi
    echo "ssh $USERNAME@$IP_ADDRESS -i $PRIVATE_KEY -p $PORT"
}
private_func_get_scp_command() {
    local path=$1
    local to_send_path=$2
    if [[ -z $PORT ]]; then
        PORT=22
    fi

    if [[ -n $to_send_path ]]; then
        echo "scp -P $PORT -i $PRIVATE_KEY $to_send_path $USERNAME@$IP_ADDRESS:$path"
    else
        echo "scp -i $PRIVATE_KEY -P $PORT $USERNAME@$IP_ADDRESS:$path"
    fi
}
func_server_setup_syncpass_version() {
    SSH_COMMAND=$(private_func_get_ssh_command)
    local result=$($SSH_COMMAND "
        if [ -f ${SYNCPASS_VERSION_PATH} ]; then
            echo 'Syncpass version already exists on the server.'
        else
            echo 'VERSION=1' > $SYNCPASS_VERSION_PATH
            echo '>>> Added syncpass version file to server'
        fi
    ")
    echo $result
}

# impo
func_get_server_version() {
    SSH_COMMAND=$(private_func_get_ssh_command)
    if $SSH_COMMAND "cat $SYNCPASS_VERSION_PATH" | grep "VERSION=" | cut -d'=' -f2; then
        echo $version
    else
        print_status "ERROR" "✗ ERROR - func_get_server_version: SSH command failed."
        exit 1
    fi
}

# impo
func_update_server_version() {
    if [[ -n "$1" ]]; then
        SSH_COMMAND=$(private_func_get_ssh_command)
        if $SSH_COMMAND "echo \"VERSION=$1\" > $SYNCPASS_VERSION_PATH"; then
            print_status "OK" "✓ SSH successful"
        else
            print_status "ERROR" "✗ func_update_server_version: SSH command failed."
            exit 1
        fi
    else
        print_status "ERROR" "✗ func_update_server_version: Version arguement required."
        exit 1
    fi
}

# impo
func_update_server_passwordstore() {
    # requirement: C_PATH
    # TODO verify env settings
    if [ -d ~/.password-store ]; then
        print_status "INFO" ">>> Found .password-store, preparing to send to server."
    else
        print_status "ERROR" "> Could not find .password-store, try creating passwords locally first"
        exit 1
    fi

    # compress local .password-store
    print_status "INFO" ">>> Compressing local .password-store ..."
    local compressed_zip_path="${C_PATH}/$PASSWORD_STORE_ZIP_FILENAME_LOCAL"
    if cd $HOME && tar --warning=no-timestamp -czf $compressed_zip_path .password-store; then
        print_status "OK" "✓ Compressed local .password-store to $compressed_zip_path\n"
    else
        print_status "ERROR" "✗ func_update_server_passwordstore: Compressing local .password-store failed."
        exit 1
    fi

    # send compressed local to server
    if $(private_func_get_scp_command "~/${PASSWORD_STORE_ZIP_FILENAME_SERVER}" $compressed_zip_path); then
        echo -e ""
        print_status "OK" "✓ Sent local .password-store to the server"
    else
        print_status "ERROR" "✗ func_update_server_passwordstore: SCP command failed."
        exit 1
    fi

    stty sane

    # # decompress sent local on the server
    # if $SSH_COMMAND "mkdir -p ~/.password-store && tar -xzf ~/$PASSWORD_STORE_ZIP_FILENAME_SERVER -C ~/"; then
    #     echo -e "✓ Successfully synced local .password-store to the server"
    # else
    #     echo -e "✗ ERROR - func_update_server_passwordstore: SCP command failed."
    #     exit 1
    # fi
}

#impo
func_get_server_passwordstore() {
    # requirement: settings: C_PATH
    # TODO check if settings exist

    SSH_COMMAND=$(private_func_get_ssh_command)
    if $SSH_COMMAND "[ -f ~/$PASSWORD_STORE_ZIP_FILENAME_SERVER ]"; then
        print_status "OK" "✓ Found compressed password-store on server\n"
    else
        print_status "ERROR" "✗ .password-store does not exist on the server, try uploading passwords first"
        exit 1
    fi

    # download server's password store on local
    if $(private_func_get_scp_command "~/${PASSWORD_STORE_ZIP_FILENAME_SERVER}") $C_PATH; then
        echo -e ""
        print_status "OK" "✓ Downloaded .password-store from server -> $PASSWORD_STORE_ZIP_FILENAME_SERVER"
    else
        print_status "ERROR" "✗ func_get_server_passwordstore: SCP command failed."
        exit 1
    fi

    # remove current .password-store state
    if rm -rf ~/.password-store; then
        print_status "INFO" "> Replacing local .password-store with the one from server"
    else
        print_status "ERROR" "✗ func_get_server_passwordstore: removing .password-store failed"
    fi

    # # unzip downloaded
    if tar --warning=no-timestamp -xzf "$C_PATH/$PASSWORD_STORE_ZIP_FILENAME_SERVER"  -C ~/; then
        print_status "OK" "✓ Successfully synced local .password-store from the server"
    else
        print_status "ERROR" "✗ func_get_server_passwordstore: tar command failed."
        exit 1
    fi
}
